
<!-- README.md is generated from README.Rmd. Please edit that file -->

# spbridge: Marginally interpretable spatial logistic regression with bridge processes

This is a software repository corresponding to the manuscript

> “Marginally interpretable spatial logistic regression with bridge
> processes” by Changwoo Lee and David B. Dunson

See R folder for the functions, which contains

- bridge.R: univariate and multivariate bridge distribution and normal
  variance mixing distributions
- splogi_bridge.R: spatial logistic model with bridge process random
  effect, using Matern kernel
- splogi_bridge_lowrank.R: spatial logistic model with bridge process
  random effect, using low-rank Matern kernel
- splogi_gaussian.R: spatial logistic model with Gaussian process random
  effect, using Matern kernel
- splogi_gaussian_lowrank.R: spatial logistic model with Gaussian
  process random effect, using low-rank Matern kernel

<!-- badges: start -->
<!-- badges: end -->

## Case study: Childhood malaria in the Gambia

### 1. Data preparation

``` r
library(geoR)# read the data 
#> --------------------------------------------------------------
#>  Analysis of Geostatistical Data
#>  For an Introduction to geoR go to http://www.leg.ufpr.br/geoR
#>  geoR version 1.9-4 (built on 2024-02-14) is now loaded
#> --------------------------------------------------------------
data(gambia)
N = length(gambia$pos) # 2035
n = length(unique(gambia$x)) # 65
y = gambia$pos # binary response, N = 2035 by 1 vector

# standardized covariates following Gelman et al (2008)
intercept = rep(1,N) # intercept
age = scale(gambia$age/365, scale = 2*sd(gambia$age/365)) # in years
netuse = gambia$netuse - mean(gambia$netuse)
treated = gambia$treated - mean(gambia$treated)
green = scale(gambia$green, scale = 2*sd(gambia$green))
green2 = scale(gambia$green^2, scale = 2*sd(gambia$green^2))
healthctr = gambia$phc - mean(gambia$phc)

X = cbind(intercept, age, netuse, treated, green, green2, healthctr)
colnames(X) = c("(Intercept)", "age", "netuse", "treated", "green", "green2", "healthctr")

centers = c(attr(age, "scaled:center"), mean(gambia$netuse), mean(gambia$treated), 
            attr(green, "scaled:center"), attr(green2, "scaled:center"), mean(gambia$phc))
scales = c(attr(age, "scaled:scale"), 1, 1, attr(green, "scaled:scale"), attr(green2, "scaled:scale"), 1)
  
# define id based on spatial coords unique values
id = as.numeric(factor(paste(gambia$x, gambia$y))) 
coords = unique(cbind(gambia$x, gambia$y)/1000) # n by 2 matrix, in km
```

### 2. Fit the spatial logistic models

``` r
source("R/bridge.R")
source("R/miscfunctions.R")
source("R/splogi_bridge.R")
source("R/splogi_gaussian.R")
```

``` r
fit_bridge = splogi_bridge(y = y,
                   X = X,
                   id = id,
                   priors = list(beta_intercept_scale = 10,
                                 beta_scale = 2.5, beta_df = Inf, 
                                 rho_lb = 0.01, rho_ub = 100),
                   coords = coords,
                   smoothness = 0.5, nburn = 1000, nsave = 10000, nthin = 1)
#>   |                                                                              |                                                                      |   0%  |                                                                              |                                                                      |   1%  |                                                                              |=                                                                     |   1%  |                                                                              |=                                                                     |   2%  |                                                                              |==                                                                    |   2%  |                                                                              |==                                                                    |   3%  |                                                                              |==                                                                    |   4%  |                                                                              |===                                                                   |   4%  |                                                                              |===                                                                   |   5%  |                                                                              |====                                                                  |   5%  |                                                                              |====                                                                  |   6%  |                                                                              |=====                                                                 |   6%  |                                                                              |=====                                                                 |   7%  |                                                                              |=====                                                                 |   8%  |                                                                              |======                                                                |   8%  |                                                                              |======                                                                |   9%  |                                                                              |=======                                                               |   9%  |                                                                              |=======                                                               |  10%  |                                                                              |=======                                                               |  11%  |                                                                              |========                                                              |  11%  |                                                                              |========                                                              |  12%  |                                                                              |=========                                                             |  12%  |                                                                              |=========                                                             |  13%  |                                                                              |=========                                                             |  14%  |                                                                              |==========                                                            |  14%  |                                                                              |==========                                                            |  15%  |                                                                              |===========                                                           |  15%  |                                                                              |===========                                                           |  16%  |                                                                              |============                                                          |  16%  |                                                                              |============                                                          |  17%  |                                                                              |============                                                          |  18%  |                                                                              |=============                                                         |  18%  |                                                                              |=============                                                         |  19%  |                                                                              |==============                                                        |  19%  |                                                                              |==============                                                        |  20%  |                                                                              |==============                                                        |  21%  |                                                                              |===============                                                       |  21%  |                                                                              |===============                                                       |  22%  |                                                                              |================                                                      |  22%  |                                                                              |================                                                      |  23%  |                                                                              |================                                                      |  24%  |                                                                              |=================                                                     |  24%  |                                                                              |=================                                                     |  25%  |                                                                              |==================                                                    |  25%  |                                                                              |==================                                                    |  26%  |                                                                              |===================                                                   |  26%  |                                                                              |===================                                                   |  27%  |                                                                              |===================                                                   |  28%  |                                                                              |====================                                                  |  28%  |                                                                              |====================                                                  |  29%  |                                                                              |=====================                                                 |  29%  |                                                                              |=====================                                                 |  30%  |                                                                              |=====================                                                 |  31%  |                                                                              |======================                                                |  31%  |                                                                              |======================                                                |  32%  |                                                                              |=======================                                               |  32%  |                                                                              |=======================                                               |  33%  |                                                                              |=======================                                               |  34%  |                                                                              |========================                                              |  34%  |                                                                              |========================                                              |  35%  |                                                                              |=========================                                             |  35%  |                                                                              |=========================                                             |  36%  |                                                                              |==========================                                            |  36%  |                                                                              |==========================                                            |  37%  |                                                                              |==========================                                            |  38%  |                                                                              |===========================                                           |  38%  |                                                                              |===========================                                           |  39%  |                                                                              |============================                                          |  39%  |                                                                              |============================                                          |  40%  |                                                                              |============================                                          |  41%  |                                                                              |=============================                                         |  41%  |                                                                              |=============================                                         |  42%  |                                                                              |==============================                                        |  42%  |                                                                              |==============================                                        |  43%  |                                                                              |==============================                                        |  44%  |                                                                              |===============================                                       |  44%  |                                                                              |===============================                                       |  45%  |                                                                              |================================                                      |  45%  |                                                                              |================================                                      |  46%  |                                                                              |=================================                                     |  46%  |                                                                              |=================================                                     |  47%  |                                                                              |=================================                                     |  48%  |                                                                              |==================================                                    |  48%  |                                                                              |==================================                                    |  49%  |                                                                              |===================================                                   |  49%  |                                                                              |===================================                                   |  50%  |                                                                              |===================================                                   |  51%  |                                                                              |====================================                                  |  51%  |                                                                              |====================================                                  |  52%  |                                                                              |=====================================                                 |  52%  |                                                                              |=====================================                                 |  53%  |                                                                              |=====================================                                 |  54%  |                                                                              |======================================                                |  54%  |                                                                              |======================================                                |  55%  |                                                                              |=======================================                               |  55%  |                                                                              |=======================================                               |  56%  |                                                                              |========================================                              |  56%  |                                                                              |========================================                              |  57%  |                                                                              |========================================                              |  58%  |                                                                              |=========================================                             |  58%  |                                                                              |=========================================                             |  59%  |                                                                              |==========================================                            |  59%  |                                                                              |==========================================                            |  60%  |                                                                              |==========================================                            |  61%  |                                                                              |===========================================                           |  61%  |                                                                              |===========================================                           |  62%  |                                                                              |============================================                          |  62%  |                                                                              |============================================                          |  63%  |                                                                              |============================================                          |  64%  |                                                                              |=============================================                         |  64%  |                                                                              |=============================================                         |  65%  |                                                                              |==============================================                        |  65%  |                                                                              |==============================================                        |  66%  |                                                                              |===============================================                       |  66%  |                                                                              |===============================================                       |  67%  |                                                                              |===============================================                       |  68%  |                                                                              |================================================                      |  68%  |                                                                              |================================================                      |  69%  |                                                                              |=================================================                     |  69%  |                                                                              |=================================================                     |  70%  |                                                                              |=================================================                     |  71%  |                                                                              |==================================================                    |  71%  |                                                                              |==================================================                    |  72%  |                                                                              |===================================================                   |  72%  |                                                                              |===================================================                   |  73%  |                                                                              |===================================================                   |  74%  |                                                                              |====================================================                  |  74%  |                                                                              |====================================================                  |  75%  |                                                                              |=====================================================                 |  75%  |                                                                              |=====================================================                 |  76%  |                                                                              |======================================================                |  76%  |                                                                              |======================================================                |  77%  |                                                                              |======================================================                |  78%  |                                                                              |=======================================================               |  78%  |                                                                              |=======================================================               |  79%  |                                                                              |========================================================              |  79%  |                                                                              |========================================================              |  80%  |                                                                              |========================================================              |  81%  |                                                                              |=========================================================             |  81%  |                                                                              |=========================================================             |  82%  |                                                                              |==========================================================            |  82%  |                                                                              |==========================================================            |  83%  |                                                                              |==========================================================            |  84%  |                                                                              |===========================================================           |  84%  |                                                                              |===========================================================           |  85%  |                                                                              |============================================================          |  85%  |                                                                              |============================================================          |  86%  |                                                                              |=============================================================         |  86%  |                                                                              |=============================================================         |  87%  |                                                                              |=============================================================         |  88%  |                                                                              |==============================================================        |  88%  |                                                                              |==============================================================        |  89%  |                                                                              |===============================================================       |  89%  |                                                                              |===============================================================       |  90%  |                                                                              |===============================================================       |  91%  |                                                                              |================================================================      |  91%  |                                                                              |================================================================      |  92%  |                                                                              |=================================================================     |  92%  |                                                                              |=================================================================     |  93%  |                                                                              |=================================================================     |  94%  |                                                                              |==================================================================    |  94%  |                                                                              |==================================================================    |  95%  |                                                                              |===================================================================   |  95%  |                                                                              |===================================================================   |  96%  |                                                                              |====================================================================  |  96%  |                                                                              |====================================================================  |  97%  |                                                                              |====================================================================  |  98%  |                                                                              |===================================================================== |  98%  |                                                                              |===================================================================== |  99%  |                                                                              |======================================================================|  99%  |                                                                              |======================================================================| 100%
fit_bridge$t_mcmc
#> Time difference of 112.1113 secs
fit_gaussian = splogi_gaussian(y = y,
                   X = X,
                   id = id,
                   priors = list(beta_intercept_scale = 10,
                                 beta_scale = 2.5, beta_df = Inf, 
                                 rho_lb = 0.01, rho_ub = 100),
                   coords = coords,
                   smoothness = 0.5, nburn = 1000, nsave = 10000, nthin = 1)
#>   |                                                                              |                                                                      |   0%  |                                                                              |                                                                      |   1%  |                                                                              |=                                                                     |   1%  |                                                                              |=                                                                     |   2%  |                                                                              |==                                                                    |   2%  |                                                                              |==                                                                    |   3%  |                                                                              |==                                                                    |   4%  |                                                                              |===                                                                   |   4%  |                                                                              |===                                                                   |   5%  |                                                                              |====                                                                  |   5%  |                                                                              |====                                                                  |   6%  |                                                                              |=====                                                                 |   6%  |                                                                              |=====                                                                 |   7%  |                                                                              |=====                                                                 |   8%  |                                                                              |======                                                                |   8%  |                                                                              |======                                                                |   9%  |                                                                              |=======                                                               |   9%  |                                                                              |=======                                                               |  10%  |                                                                              |=======                                                               |  11%  |                                                                              |========                                                              |  11%  |                                                                              |========                                                              |  12%  |                                                                              |=========                                                             |  12%  |                                                                              |=========                                                             |  13%  |                                                                              |=========                                                             |  14%  |                                                                              |==========                                                            |  14%  |                                                                              |==========                                                            |  15%  |                                                                              |===========                                                           |  15%  |                                                                              |===========                                                           |  16%  |                                                                              |============                                                          |  16%  |                                                                              |============                                                          |  17%  |                                                                              |============                                                          |  18%  |                                                                              |=============                                                         |  18%  |                                                                              |=============                                                         |  19%  |                                                                              |==============                                                        |  19%  |                                                                              |==============                                                        |  20%  |                                                                              |==============                                                        |  21%  |                                                                              |===============                                                       |  21%  |                                                                              |===============                                                       |  22%  |                                                                              |================                                                      |  22%  |                                                                              |================                                                      |  23%  |                                                                              |================                                                      |  24%  |                                                                              |=================                                                     |  24%  |                                                                              |=================                                                     |  25%  |                                                                              |==================                                                    |  25%  |                                                                              |==================                                                    |  26%  |                                                                              |===================                                                   |  26%  |                                                                              |===================                                                   |  27%  |                                                                              |===================                                                   |  28%  |                                                                              |====================                                                  |  28%  |                                                                              |====================                                                  |  29%  |                                                                              |=====================                                                 |  29%  |                                                                              |=====================                                                 |  30%  |                                                                              |=====================                                                 |  31%  |                                                                              |======================                                                |  31%  |                                                                              |======================                                                |  32%  |                                                                              |=======================                                               |  32%  |                                                                              |=======================                                               |  33%  |                                                                              |=======================                                               |  34%  |                                                                              |========================                                              |  34%  |                                                                              |========================                                              |  35%  |                                                                              |=========================                                             |  35%  |                                                                              |=========================                                             |  36%  |                                                                              |==========================                                            |  36%  |                                                                              |==========================                                            |  37%  |                                                                              |==========================                                            |  38%  |                                                                              |===========================                                           |  38%  |                                                                              |===========================                                           |  39%  |                                                                              |============================                                          |  39%  |                                                                              |============================                                          |  40%  |                                                                              |============================                                          |  41%  |                                                                              |=============================                                         |  41%  |                                                                              |=============================                                         |  42%  |                                                                              |==============================                                        |  42%  |                                                                              |==============================                                        |  43%  |                                                                              |==============================                                        |  44%  |                                                                              |===============================                                       |  44%  |                                                                              |===============================                                       |  45%  |                                                                              |================================                                      |  45%  |                                                                              |================================                                      |  46%  |                                                                              |=================================                                     |  46%  |                                                                              |=================================                                     |  47%  |                                                                              |=================================                                     |  48%  |                                                                              |==================================                                    |  48%  |                                                                              |==================================                                    |  49%  |                                                                              |===================================                                   |  49%  |                                                                              |===================================                                   |  50%  |                                                                              |===================================                                   |  51%  |                                                                              |====================================                                  |  51%  |                                                                              |====================================                                  |  52%  |                                                                              |=====================================                                 |  52%  |                                                                              |=====================================                                 |  53%  |                                                                              |=====================================                                 |  54%  |                                                                              |======================================                                |  54%  |                                                                              |======================================                                |  55%  |                                                                              |=======================================                               |  55%  |                                                                              |=======================================                               |  56%  |                                                                              |========================================                              |  56%  |                                                                              |========================================                              |  57%  |                                                                              |========================================                              |  58%  |                                                                              |=========================================                             |  58%  |                                                                              |=========================================                             |  59%  |                                                                              |==========================================                            |  59%  |                                                                              |==========================================                            |  60%  |                                                                              |==========================================                            |  61%  |                                                                              |===========================================                           |  61%  |                                                                              |===========================================                           |  62%  |                                                                              |============================================                          |  62%  |                                                                              |============================================                          |  63%  |                                                                              |============================================                          |  64%  |                                                                              |=============================================                         |  64%  |                                                                              |=============================================                         |  65%  |                                                                              |==============================================                        |  65%  |                                                                              |==============================================                        |  66%  |                                                                              |===============================================                       |  66%  |                                                                              |===============================================                       |  67%  |                                                                              |===============================================                       |  68%  |                                                                              |================================================                      |  68%  |                                                                              |================================================                      |  69%  |                                                                              |=================================================                     |  69%  |                                                                              |=================================================                     |  70%  |                                                                              |=================================================                     |  71%  |                                                                              |==================================================                    |  71%  |                                                                              |==================================================                    |  72%  |                                                                              |===================================================                   |  72%  |                                                                              |===================================================                   |  73%  |                                                                              |===================================================                   |  74%  |                                                                              |====================================================                  |  74%  |                                                                              |====================================================                  |  75%  |                                                                              |=====================================================                 |  75%  |                                                                              |=====================================================                 |  76%  |                                                                              |======================================================                |  76%  |                                                                              |======================================================                |  77%  |                                                                              |======================================================                |  78%  |                                                                              |=======================================================               |  78%  |                                                                              |=======================================================               |  79%  |                                                                              |========================================================              |  79%  |                                                                              |========================================================              |  80%  |                                                                              |========================================================              |  81%  |                                                                              |=========================================================             |  81%  |                                                                              |=========================================================             |  82%  |                                                                              |==========================================================            |  82%  |                                                                              |==========================================================            |  83%  |                                                                              |==========================================================            |  84%  |                                                                              |===========================================================           |  84%  |                                                                              |===========================================================           |  85%  |                                                                              |============================================================          |  85%  |                                                                              |============================================================          |  86%  |                                                                              |=============================================================         |  86%  |                                                                              |=============================================================         |  87%  |                                                                              |=============================================================         |  88%  |                                                                              |==============================================================        |  88%  |                                                                              |==============================================================        |  89%  |                                                                              |===============================================================       |  89%  |                                                                              |===============================================================       |  90%  |                                                                              |===============================================================       |  91%  |                                                                              |================================================================      |  91%  |                                                                              |================================================================      |  92%  |                                                                              |=================================================================     |  92%  |                                                                              |=================================================================     |  93%  |                                                                              |=================================================================     |  94%  |                                                                              |==================================================================    |  94%  |                                                                              |==================================================================    |  95%  |                                                                              |===================================================================   |  95%  |                                                                              |===================================================================   |  96%  |                                                                              |====================================================================  |  96%  |                                                                              |====================================================================  |  97%  |                                                                              |====================================================================  |  98%  |                                                                              |===================================================================== |  98%  |                                                                              |===================================================================== |  99%  |                                                                              |======================================================================|  99%  |                                                                              |======================================================================| 100%
fit_gaussian$t_mcmc
#> Time difference of 81.6279 secs
```

### 3. Summarize the result

``` r
scaleback <- function(x, centers, scales){
  c(x[1] - sum((x[-1] * centers) / scales),
    x[-1] / scales)
}

# summary from bridge process
beta_b_save = fit_bridge$post_save[,1:ncol(X)]
beta_b_save_orig = coda::mcmc(t(apply(beta_b_save, 1, scaleback, centers, scales)))
betam_b_save_orig = coda::mcmc(t(apply(fit_bridge$betam_save, 1, scaleback, centers, scales)))


summary(betam_b_save_orig)# population-averaged, bridge process random effect
#> 
#> Iterations = 1:10000
#> Thinning interval = 1 
#> Number of chains = 1 
#> Sample size per chain = 10000 
#> 
#> 1. Empirical mean and standard deviation for each variable,
#>    plus standard error of the mean:
#> 
#>                  Mean        SD  Naive SE Time-series SE
#> (Intercept)  1.773474 2.2434642 2.243e-02      3.177e-02
#> age          0.183401 0.0485521 4.855e-04      1.293e-03
#> netuse      -0.271619 0.1322708 1.323e-03      2.287e-03
#> treated     -0.273045 0.1622333 1.622e-03      2.829e-03
#> green       -0.097392 0.0863465 8.635e-04      1.197e-03
#> green2       0.001032 0.0009069 9.069e-06      1.357e-05
#> healthctr   -0.222375 0.1722213 1.722e-03      2.129e-03
#> 
#> 2. Quantiles for each variable:
#> 
#>                   2.5%        25%       50%      75%     97.5%
#> (Intercept) -2.7234261  0.3570736  1.761773  3.22177  6.233730
#> age          0.0939965  0.1488619  0.181821  0.21632  0.282767
#> netuse      -0.5512240 -0.3545885 -0.263388 -0.17927 -0.033833
#> treated     -0.6168918 -0.3746077 -0.263497 -0.16054  0.016848
#> green       -0.2713480 -0.1532649 -0.095463 -0.04085  0.072723
#> green2      -0.0007231  0.0004315  0.001004  0.00162  0.002876
#> healthctr   -0.5756205 -0.3295045 -0.214836 -0.11076  0.100228

summary(beta_b_save_orig)# site(subject)-specific, bridge process random effect 
#> 
#> Iterations = 1:10000
#> Thinning interval = 1 
#> Number of chains = 1 
#> Sample size per chain = 10000 
#> 
#> 1. Empirical mean and standard deviation for each variable,
#>    plus standard error of the mean:
#> 
#>                  Mean       SD  Naive SE Time-series SE
#> (Intercept)  2.396873 2.936328 2.936e-02      4.139e-02
#> age          0.243988 0.044824 4.482e-04      5.314e-04
#> netuse      -0.361201 0.158784 1.588e-03      1.748e-03
#> treated     -0.361574 0.198754 1.988e-03      2.306e-03
#> green       -0.130109 0.110874 1.109e-03      1.426e-03
#> green2       0.001372 0.001158 1.158e-05      1.469e-05
#> healthctr   -0.296660 0.219197 2.192e-03      2.438e-03
#> 
#> 2. Quantiles for each variable:
#> 
#>                   2.5%        25%       50%       75%     97.5%
#> (Intercept) -3.5611966  0.4989163  2.426841  4.420101  8.034241
#> age          0.1552054  0.2142659  0.244024  0.273736  0.331283
#> netuse      -0.6712277 -0.4686643 -0.361670 -0.254592 -0.046902
#> treated     -0.7461184 -0.4953401 -0.360547 -0.227627  0.023102
#> green       -0.3419118 -0.2063777 -0.132164 -0.056158  0.093851
#> green2      -0.0009623  0.0006059  0.001397  0.002159  0.003575
#> healthctr   -0.7201142 -0.4381944 -0.297766 -0.153168  0.137374

# Compare with Gaussian process random effects model
beta_g_save = fit_gaussian$post_save[,1:ncol(X)]
beta_g_save_orig = coda::mcmc(t(apply(beta_g_save, 1, scaleback, centers, scales)))
summary(beta_g_save_orig)# site(subject)-specific, Gaussian process random effect
#> 
#> Iterations = 1:10000
#> Thinning interval = 1 
#> Number of chains = 1 
#> Sample size per chain = 10000 
#> 
#> 1. Empirical mean and standard deviation for each variable,
#>    plus standard error of the mean:
#> 
#>                 Mean       SD  Naive SE Time-series SE
#> (Intercept)  2.38580 2.778848 2.779e-02      0.0385199
#> age          0.24438 0.044302 4.430e-04      0.0005320
#> netuse      -0.36483 0.158968 1.590e-03      0.0017245
#> treated     -0.36027 0.198801 1.988e-03      0.0023099
#> green       -0.13333 0.105719 1.057e-03      0.0012306
#> green2       0.00143 0.001106 1.106e-05      0.0000126
#> healthctr   -0.29378 0.213838 2.138e-03      0.0022937
#> 
#> 2. Quantiles for each variable:
#> 
#>                   2.5%        25%       50%       75%     97.5%
#> (Intercept) -3.0822304  0.4828715  2.389523  4.280888  7.769783
#> age          0.1583052  0.2144629  0.244289  0.274252  0.331521
#> netuse      -0.6863580 -0.4712346 -0.362780 -0.258348 -0.057235
#> treated     -0.7459897 -0.4956602 -0.360175 -0.224838  0.028512
#> green       -0.3362722 -0.2061718 -0.133901 -0.061897  0.074940
#> green2      -0.0007254  0.0006936  0.001436  0.002192  0.003527
#> healthctr   -0.7155022 -0.4354761 -0.292778 -0.151044  0.127480
```

``` r
# further mcmc summary examples
library(bayesplot)
#> This is bayesplot version 1.10.0
#> - Online documentation and vignettes at mc-stan.org/bayesplot
#> - bayesplot theme set to bayesplot::theme_default()
#>    * Does _not_ affect other ggplot2 plots
#>    * See ?bayesplot_theme_set for details on theme setting
mcmc_trace(fit_bridge$post_save)
```

![](README_files/figure-gfm/unnamed-chunk-6-1.png)<!-- -->

``` r
mcmc_trace(fit_gaussian$post_save)
```

![](README_files/figure-gfm/unnamed-chunk-6-2.png)<!-- -->
